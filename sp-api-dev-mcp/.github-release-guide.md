# GitHub Release Guide

This guide explains how to release a new version of the SP-API Dev MCP Server.

## Prerequisites

1. **NPM Token**: Ensure the `NPM_TOKEN` secret is configured in the GitHub repository
   - Go to Settings > Secrets and variables > Actions
   - Add a new repository secret named `NPM_TOKEN`
   - Value should be your npm access token with publish permissions for `@amazon-sp-api-release` scope

2. **Permissions**: You need write access to the repository to trigger the workflow

## Release Process

### 1. Prepare the Release

Before triggering the release workflow:

1. **Update CHANGELOG.md**
   ```bash
   cd sp-api-dev-mcp
   # Edit CHANGELOG.md to document changes
   ```

2. **Ensure all tests pass locally**
   ```bash
   npm test
   npm run lint
   npm run type-check
   npm run build
   ```

3. **Commit and push changes**
   ```bash
   git add CHANGELOG.md
   git commit -m "docs: update changelog for v0.1.0"
   git push origin main
   ```

### 2. Trigger the Release Workflow

1. Go to the GitHub repository
2. Click on "Actions" tab
3. Select "Release MCP Server" workflow from the left sidebar
4. Click "Run workflow" button
5. Enter the new version number (e.g., `0.1.0`)
6. Click "Run workflow"

### 3. What the Workflow Does

The workflow performs the following steps:

**Job 1: Test and Build**
- Checks out the code
- Sets up Node.js 22
- Installs dependencies
- Runs linter
- Runs type checking
- Runs all tests
- Builds the project
- Verifies build output

**Job 2: Release to NPM**
- Updates package.json version
- Installs dependencies
- Builds for production
- Publishes to npm registry with public access

**Job 3: Tag and Release**
- Creates a Git tag (e.g., `mcp-server-v0.1.0`)
- Pushes the tag to GitHub
- Creates a GitHub Release with release notes

### 4. Verify the Release

After the workflow completes:

1. **Check npm**: Visit https://www.npmjs.com/package/@amazon-sp-api-release/dev-mcp
2. **Check GitHub Releases**: Visit the Releases page on GitHub
3. **Test installation**:
   ```bash
   npm install -g @amazon-sp-api-release/dev-mcp@0.1.0
   ```

## Version Numbering

Follow [Semantic Versioning](https://semver.org/):

- **MAJOR** version (1.0.0): Incompatible API changes
- **MINOR** version (0.1.0): Add functionality in a backward compatible manner
- **PATCH** version (0.0.1): Backward compatible bug fixes

## Troubleshooting

### Workflow fails at "Publish to npm"

**Error**: `npm ERR! code E401` or `npm ERR! need auth`

**Solution**: 
- Verify `NPM_TOKEN` secret is set correctly
- Ensure the token has publish permissions for `@amazon-sp-api-release` scope
- Check token hasn't expired

### Workflow fails at "Run tests"

**Solution**:
- Run tests locally first: `npm test`
- Fix any failing tests before triggering the workflow
- Ensure all dependencies are properly listed in package.json

### Workflow fails at "Create Git tag"

**Error**: Tag already exists

**Solution**:
- Delete the existing tag if needed:
  ```bash
  git tag -d mcp-server-v0.1.0
  git push origin :refs/tags/mcp-server-v0.1.0
  ```
- Use a different version number

### Package published but GitHub Release fails

**Solution**:
- The package is already on npm, which is the most important part
- You can manually create a GitHub Release:
  1. Go to Releases page
  2. Click "Draft a new release"
  3. Choose the tag or create new tag
  4. Add release notes
  5. Publish release

## Manual Release (Fallback)

If the automated workflow fails, you can release manually:

```bash
# 1. Update version
cd sp-api-dev-mcp
npm version 0.1.0 --no-git-tag-version

# 2. Build
npm run build

# 3. Publish to npm
npm publish --access public

# 4. Create and push tag
git add package.json package-lock.json
git commit -m "chore: release v0.1.0"
git tag -a mcp-server-v0.1.0 -m "Release v0.1.0"
git push origin main
git push origin mcp-server-v0.1.0

# 5. Create GitHub Release manually via UI
```

## Post-Release Checklist

- [ ] Verify package is available on npm
- [ ] Test installation: `npm install -g @amazon-sp-api-release/dev-mcp@<version>`
- [ ] Verify GitHub Release is created
- [ ] Update documentation if needed
- [ ] Announce release (if applicable)
- [ ] Update CHANGELOG.md for next version
